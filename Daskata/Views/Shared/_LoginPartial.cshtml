@using Daskata.Infrastructure.Data
@using Microsoft.AspNetCore.Identity
@using Daskata.Infrastructure.Data.Models
@using Microsoft.EntityFrameworkCore
@inject SignInManager<UserProfile> _signInManager
@inject UserManager<UserProfile> _userManager
@inject DaskataDbContext _context

@{
    var loggedUser = await _userManager.GetUserAsync(User);
    var userRolesNames = await _userManager.GetRolesAsync(loggedUser!);
    var loggedUserId = loggedUser?.Id.ToString();

    var roleName = userRolesNames.FirstOrDefault() ?? "None";

    var userFirstName = loggedUser?.FirstName ?? "Име";
    var userLastName = loggedUser?.LastName ?? "Фамилия";
}

<div id="header">
    <div id="weather"></div>
</div>
<div class="navbar-nav">
    <div class="dropdown">
        <button class="dropbtn" id="profile-picture">
            <img class="profile-pic" src="@loggedUser!.ProfilePictureUrl" alt="Профил">
        </button>
        <div class="dropdown-content" id="dropdown-menu">
            <span class="profile-username">@@@loggedUser</span> <br />
            <span class="profile-names">@userFirstName @userLastName</span><br />

            @{
                if (roleName == "Admin")
                {
                    <span class="profile-role">⭐⭐⭐⭐ Вие сте админ!</span> <hr />
                }
                else if (roleName == "Manager")
                {
                    <span class="profile-role">⭐⭐⭐ Вие сте мениджър!</span> <hr />
                }
                else if (roleName == "Teacher")
                {
                    <span class="profile-role">⭐⭐ Вие сте учител!</span> <hr />
                }
                else if (roleName == "Student")
                {
                    <span class="profile-role">⭐ Вие сте ученик!</span> <hr />
                }
                else if (roleName == "None")
                {
                    <span class="profile-role">❌ Вие нямате зададена роля</span> <hr />
                }
            }

            <a asp-area="Identity" asp-page="/Account/Manage/Index">Профилът ми</a>
            <a href="#">Минали изпити</a>
            <a href="#">Бъдещи изпити</a>
            <a href="#">Моите хора</a>
            <a asp-controller="User" asp-action="Logout" id="logoutLink">Изход</a>
        </div>
    </div>
</div>

<script>
    //Profile menu dropdown
    document.addEventListener("DOMContentLoaded", function () {
        var profilePicture = document.getElementById("profile-picture");
        var dropdownMenu = document.getElementById("dropdown-menu");

        profilePicture.addEventListener("click", function (event) {
            event.stopPropagation();
            dropdownMenu.classList.toggle("show");
        });

        window.addEventListener("click", function (event) {
            if (!event.target.matches('#profile-picture')) {
                dropdownMenu.classList.remove("show");
            }
        });
    });
</script>


<script>
    //Weather AJAX and API
    $(document).ready(function () {
        var apiKey = 'API-код-като-си-взема-абонамент';
        var location = 'Sofia';

        $.ajax({
            url: 'https://api.openweathermap.org/data/2.5/weather',
            type: 'GET',
            data: {
                q: location,
                appid: apiKey,
                units: 'metric'
            },
            success: function (response) {
                var temperature = response.main.temp;
                var condition = response.weather[0].main;

                $('#weather').text('Temperature: ' + temperature + '°C, Condition: ' + condition);
            },
            error: function (xhr, status, error) {
                console.error('Failed to fetch weather data:', error);
            }
        })
    });
</script>

<script>
    //Logout confirm
    document.getElementById("logoutLink").addEventListener("click", function (event) {
        event.preventDefault();
        if (confirm("Ще излезете от профила си.")) {
            window.location.href = this.href;
        }
    });
</script>